<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Coin Breaker - Token Version</title>
  <style>
    canvas { background: #222; display: block; margin: 0 auto; }
    body { text-align: center; color: white; font-family: Arial, sans-serif; background: #111; }
    #restartBtn, #connectBtn { margin-top: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Coin Breaker - Token Version</h1>
  <p>Left/Right arrow to move, Break stones and collect coins!</p>
  <canvas id="gameCanvas" width="500" height="600"></canvas>
  <br>
  <button id="connectBtn">Connect Wallet</button>
  <button id="restartBtn">Restart Game</button>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const restartBtn = document.getElementById('restartBtn');
    const connectBtn = document.getElementById('connectBtn');

    // Wallet & Web3
    let web3;
    let userAccount;
    const tokenAddress = 'YOUR_TOKEN_CONTRACT_ADDRESS';
    const tokenABI = [ /* Paste ERC-20 ABI here */ ];

    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          web3 = new Web3(window.ethereum);
          const accounts = await web3.eth.getAccounts();
          userAccount = accounts[0];
          alert('Wallet connected: ' + userAccount);
        } catch (err) { console.error(err); alert('Wallet connection failed!'); }
      } else {
        alert('MetaMask not found!');
      }
    }

    async function claimToken(amount) {
      if(!web3 || !userAccount) { alert('Connect wallet first!'); return; }
      const contract = new web3.eth.Contract(tokenABI, tokenAddress);
      try {
        const tx = await contract.methods.transfer(userAccount, amount).send({ from: userAccount });
        alert('Token claimed! Tx Hash: ' + tx.transactionHash);
      } catch (err) {
        console.error(err);
        alert('Token claim failed!');
      }
    }

    connectBtn.addEventListener('click', connectWallet);

    // Player
    const player = { x: canvas.width / 2 - 25, y: canvas.height - 50, width: 50, height: 20, speed: 5 };
    let rightPressed = false, leftPressed = false;
    document.addEventListener("keydown", e => { if(e.key==="ArrowRight") rightPressed=true; else if(e.key==="ArrowLeft") leftPressed=true; });
    document.addEventListener("keyup", e => { if(e.key==="ArrowRight") rightPressed=false; else if(e.key==="ArrowLeft") leftPressed=false; });

    // Game
    let stones = [], stoneSpeed=2, coinRadius=5, score=0, lives=3, level=1, gameOver=false;
    let bigHand=false, scoreMultiplier=1;

    function spawnStone() {
      const x = Math.random() * (canvas.width - 40);
      const size = Math.random()<0.7 ? 40:60;
      stones.push({x:x, y:-size, size:size, broken:false});
    }

    function drawPlayer() { ctx.fillStyle = bigHand ? "orange":"yellow"; ctx.fillRect(player.x, player.y, player.width, player.height); }
    function drawStones() { stones.forEach(s=>{ ctx.fillStyle=s.broken?"gray":"brown"; ctx.fillRect(s.x,s.y,s.size,s.size); }); }
    function drawCoins() { stones.forEach(s=>{ if(s.broken){ ctx.beginPath(); ctx.arc(s.x+s.size/2,s.y+s.size/2,coinRadius,0,Math.PI*2); ctx.fillStyle="gold"; ctx.fill(); ctx.closePath(); } }); }
    function drawScore() { ctx.fillStyle="white"; ctx.font="20px Arial"; ctx.fillText("Score: "+score,10,30); ctx.fillText("Lives: "+lives,10,60); ctx.fillText("Level: "+level,10,90); }

    function updateStones() {
      stones.forEach(stone=>{
        stone.y+=stoneSpeed;
        if(!stone.broken && stone.y+stone.size>=player.y && stone.x<player.x+player.width && stone.x+stone.size>player.x){
          stone.broken=true;
          score += (stone.size>40?5:1)*scoreMultiplier;
          if(score % 10 === 0) claimToken(1); // প্রতি 10 স্কোরে 1 টোকেন claim
        }
      });
      for(let i=stones.length-1;i>=0;i--){ if(stones[i].y>canvas.height+50){ if(!stones[i].broken) lives--; stones.splice(i,1); } }
      if(score >= level*20){ level++; stoneSpeed+=0.5; bigHand=Math.random()<0.3; scoreMultiplier=Math.random()<0.3?2:1; }
      if(lives<=0){ gameOver=true; restartBtn.style.display="inline-block"; }
    }

    function movePlayer(){ if(rightPressed && player.x+player.width<canvas.width) player.x+=player.speed; if(leftPressed && player.x>0) player.x-=player.speed; }
    function drawGameOver(){ ctx.fillStyle="red"; ctx.font="40px Arial"; ctx.fillText("GAME OVER",canvas.width/2-120,canvas.height/2); ctx.font="20px Arial"; ctx.fillText("Final Score: "+score,canvas.width/2-70,canvas.height/2+40); }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!gameOver){ drawPlayer(); drawStones(); drawCoins(); drawScore(); movePlayer(); updateStones(); requestAnimationFrame(draw); } 
      else drawGameOver();
    }

    setInterval(()=>{ if(!gameOver) spawnStone(); },1500);
    draw();

    restartBtn.addEventListener("click",()=>{
      stones=[]; stoneSpeed=2; score=0; lives=3; level=1; gameOver=false; bigHand=false; scoreMultiplier=1; restartBtn.style.display="none"; draw();
    });
  </script>
</body>
</html>
